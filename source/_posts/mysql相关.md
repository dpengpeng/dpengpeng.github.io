---
title: mysql相关
date: 2021-07-02 22:26:54
categories: mysql
tags:
---
1. select * for udpate
* for udpate应用的是悲观锁，根据select的数据集范围会对不同量级的数据进行加锁，
良好情况下，比如通过主键、索引定位到行，则进行行加锁，
较差情况下，可能进行表锁，使用时需要针对不同的sql进行分析，判定加锁的范围。
在高并发下，可能对性能有影响。

2. 笛卡尔积
* mysql中的inner join,left join,right join都会涉及到笛卡尔积相关概念，真实作用后的结果一般为局部笛卡尔积。
当多个表进行连接时，推荐使用on进行连接，这样可以避免两张表进行全量的笛卡尔积(两张表每个都会进行匹配一行结果)，
on作用会先根据on的条件关联出符合的两行再组成一个完整的行数据，如果使用where进行关联，则两个表会先进行全量的笛卡尔积，
然后再根据where条件把符合条件的数据筛选出来。当两张表的数据很大时，on和where的效率会很明显。

3. select 语句执行过程
* 首先通过连接器进行会话连接(加入session还没有创建,如果创建了就没有这一步)，然后进入分析器进行语法分析，然后进入优化器进行语法优化，最后进入执行器进行sql执行,如何内存中有缓存可能直接在内存中就能找到数据，如果禁用了缓存，则每次从磁盘中查找数据到内存，再返回给客户端.

4. update 语句执行过程
* 连接器->分析器->优化器->执行器,和select不同的是执行器里面逻辑不同，首先从内存中查找数据(此数据所在的数据页在内存中)，如果有直接取出对应的行数据进行更新，如果没有，则从磁盘捞出对应的数据放入内存，然后做相应的更新操作，更新完刷新内存中的值，同时写入redo log，然后再写入binglog，提交事务，代表此次更新完成。这就能保证数据库从crash状态恢复时，不会丢数据，简称crash-safe，
* redo log的文件在mysql里面通常有几个，命名格式为ib_logfile0,ib_logfile1...,个数和大小可以设置。redo log技术就是mysql中的WAL技术(write-Ahead logging),就是先写日志，在写磁盘。redo log日志放在redo log file后会在恰当的时机将数据刷到数据文件即表中。
* redo log 和binglog的刷盘策略可以设置，分别设置innodb_flush_log_at_trx_commit和sync_binlog两个都为1时就能提供两阶段提交功能，保证数据不丢失，即使mysql异常宕机重启。redo log是innodb引擎的log文件，binglog是mysql server自带的log文件。
* 何时会擦除redo log并更新到数据文件中：系统空闲时、redo log file空间不足时、mysql正常关闭时。
* 形象化的来理解数据更新操作：我们假设操作数据库相当于饭店掌柜经营生意。因为mysql的架构是mysql server 和存储引擎是分开的，所以我们假设server就是掌柜，redo log相当于临时记账的黑板，账本相当于表数据文件。通常有人来赊账或者还款时就会先将这个信息记录在黑板，等黑板记录满了或者掌柜空闲了，就会来将黑板的信息记录到账本。

